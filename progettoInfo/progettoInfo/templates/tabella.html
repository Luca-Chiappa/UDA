{% extends "base.html" %}
{% block content %}
 
<h1>Tabella</h1>
 
<button class="btn" onclick="openModal()">Aggiungi riga</button>
 
<br><br>
 
<table id="tabella">
    <tr>
        <th>ID</th>
        <th>Tipo</th>
        <th>Consumo</th>
        <th>Classe Energetica</th>
        <th>Azioni</th>
    </tr>
</table>
 
<div id="modal" class="modal">
    <div class="modal-content">
        <h3>Nuovo elemento</h3>
 
        <input id="nome" placeholder="Nome">
        <input id="consumo" placeholder="Consumo">
        <input id="classe" placeholder="Classe Energetica">
 
        <button class="btn" onclick="aggiungi()">Aggiungi</button>
        <button class="btn close" onclick="closeModal()">Chiudi</button>
    </div>
</div>
 
<script>
function openModal() {
    document.getElementById("modal").style.display = "flex";
}
 
function closeModal() {
    document.getElementById("modal").style.display = "none";
    document.getElementById("nome").value = "";
    document.getElementById("consumo").value = "";
    document.getElementById("classe").value = "";
}
 
async function loadTable() {
    try {
        const res = await fetch('/api/elettrodomestici');
        if (!res.ok) throw new Error('Errore caricamento');
        const items = await res.json();
        const table = document.getElementById('tabella');
        // remove existing rows except header
        table.querySelectorAll('tr:not(:first-child)').forEach(r => r.remove());
        items.forEach(e => {
            const row = table.insertRow(-1);
            const tipo = e.tipo || e.type || '';
            row.innerHTML = `
                <td>${e.id}</td>
                <td>${tipo}</td>
                <td>${e.consumoOrario}</td>
                <td>${e.classeEnergetica}</td>
                <td><button class="btn" onclick="deleteItem(${e.id})">Elimina</button></td>
            `;
        });
    } catch (err) {
        console.error(err);
    }
}
 
async function aggiungi() {
    const nome = document.getElementById("nome").value;
    const consumo = document.getElementById("consumo").value;
    const classe = document.getElementById("classe").value;
 
    if (!nome || !consumo || !classe) return;
 
    const body = {
        tipo: nome,
        consumoOrario: parseFloat(consumo),
        classeEnergetica: classe
    };
    try {
        const res = await fetch('/api/elettrodomestici', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.message || 'Errore creazione');
        await loadTable();
    } catch (err) {
        alert('Impossibile aggiungere: ' + err.message);
    }
    closeModal();
}
 
async function deleteItem(id) {
    try {
        const res = await fetch(`/api/elettrodomestici/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('delete failed');
        await loadTable();
    } catch (err) {
        console.error(err);
    }
}
 
document.addEventListener('DOMContentLoaded', loadTable);
</script>
 
{% endblock %}
 
 